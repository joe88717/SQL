CREATE FUNCTION dbo.fun_SplitToTable
(
    @inputString NVARCHAR(MAX), --輸入
    @delimiter NVARCHAR(1), --符號
    @position INT --第幾個
)
RETURNS NVARCHAR(MAX) --function傳回格式
AS
BEGIN
    DECLARE @result NVARCHAR(MAX)
    DECLARE @splitTable TABLE (Item NVARCHAR(MAX))
 
    DECLARE @start INT, @end INT, @count INT
 
    SET @count = 1--以@delimiter為分割後，每組字串在第幾個位置
    SET @start = 1--起始位置
    SET @end = CHARINDEX(@delimiter, @inputString)--分割字串的字符在哪個位置
 
    WHILE @end > 0
    BEGIN --擷取每個分割符號前的字串
        INSERT INTO @splitTable (Item)
        VALUES (SUBSTRING(@inputString, @start, @end - @start))  --SUBSTR (inputString, 開始位置, 長度)
 
        SET @start = @end + 1 --以上一個@delimiter當作起始位置
        SET @end = CHARINDEX(@delimiter, @inputString, @start) --找下一個@delimiter的位置
        SET @count = @count + 1 
    END
 
    INSERT INTO @splitTable (Item)--插入最後一個分割的字串，因為最後一個字串後沒有分割符號
    VALUES (SUBSTRING(@inputString, @start, LEN(@inputString) - @start + 1))
 
    SELECT @result = Item FROM @splitTable WHERE @count = @position
 
    RETURN @result
END
